---
import "../styles/global.css";
import SmoothScroll from "../islands/SmoothScroll";
import Spotlight from "../islands/Spotlight";

const {
  title = "Clawd ML Portfolio",
  description = "ML portfolio with cinematic WebGL scenes and project demos.",
  bodyClass,
} = Astro.props;
const base = import.meta.env.BASE_URL;
const blogPassword = import.meta.env.PUBLIC_BLOG_PASSWORD ?? "open";
const normalizedBase = base.endsWith("/") ? base : `${base}/`;
const blogPrefix = `${normalizedBase}blog`;
const devBlogPrefix = "/blog";
const isBlogRoute =
  Astro.url.pathname.startsWith(blogPrefix) ||
  Astro.url.pathname.startsWith(devBlogPrefix);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href={base + "favicon.svg"} />
    <script is:inline define:vars={{ blogPassword, blogPrefix, devBlogPrefix }}>
      const storedTheme = localStorage.getItem("clawd-theme");
      const prefersLight = window.matchMedia(
        "(prefers-color-scheme: light)",
      ).matches;
      const resolvedTheme =
        storedTheme === "bright" || storedTheme === "dark"
          ? storedTheme
          : prefersLight
            ? "bright"
            : "dark";
      document.documentElement.dataset.theme = resolvedTheme;
      const storedFilm = localStorage.getItem("clawd-film");
      const prefersReduced = window.matchMedia(
        "(prefers-reduced-motion: reduce)",
      ).matches;
      const prefersContrast = window.matchMedia(
        "(prefers-contrast: more)",
      ).matches;
      const filmEnabled =
        !prefersReduced &&
        !prefersContrast &&
        (storedFilm === "on"
          ? true
          : storedFilm === "off"
            ? false
            : resolvedTheme !== "bright");
      document.documentElement.dataset.film = filmEnabled ? "on" : "off";

      window.addEventListener("cut-to-project", () => {
        document.body.classList.add("warp-active");
      });

      const BLOG_PASSWORD = blogPassword;
      const BLOG_KEY = "blog-gate-until";
      const isBlogRoute =
        window.location.pathname.startsWith(blogPrefix) ||
        window.location.pathname.startsWith(devBlogPrefix);
      if (isBlogRoute) {
        const until = sessionStorage.getItem(BLOG_KEY);
        const unlocked = until && Number(until) > Date.now();
        document.addEventListener("DOMContentLoaded", () => {
          const gate = document.getElementById("blog-gate");
          const form = document.getElementById("blog-gate-form");
          const input = document.getElementById("blog-gate-input");
          const error = document.getElementById("blog-gate-error");
          if (unlocked) {
            document.documentElement.classList.remove("blog-locked");
            if (gate) gate.classList.remove("is-visible");
            return;
          }
          document.documentElement.classList.add("blog-locked");
          if (gate) gate.classList.add("is-visible");
          form?.addEventListener("submit", (event) => {
            event.preventDefault();
            if (!input) return;
            if (input.value !== BLOG_PASSWORD) {
              if (error) error.textContent = "Incorrect password";
              return;
            }
            if (error) error.textContent = "";
            const next = Date.now() + 12 * 60 * 60 * 1000;
            sessionStorage.setItem(BLOG_KEY, String(next));
            document.documentElement.classList.remove("blog-locked");
            if (gate) gate.classList.remove("is-visible");
          });
        });
      }
    </script>
    <title>{title}</title>
  </head>
  <body class:list={[bodyClass, isBlogRoute && "blog-locked"]}>
    <SmoothScroll client:load />
    <Spotlight client:load />
    <slot />
    <div
      id="blog-gate"
      class:list={["blog-gate", isBlogRoute && "is-visible"]}
      aria-hidden={!isBlogRoute}
    >
      <div class="blog-gate-card">
        <p class="text-xs uppercase tracking-[0.3em] text-mist">Private</p>
        <h2 class="mt-3 text-2xl text-glass">Enter password</h2>
        <form id="blog-gate-form" class="mt-6 flex flex-col gap-3">
          <input
            id="blog-gate-input"
            class="rounded-full border border-mist/30 bg-glass/5 px-4 py-3 text-sm text-glass placeholder:text-mist/70"
            type="password"
            autocomplete="current-password"
            placeholder="Password"
          />
          <button
            type="submit"
            class="rounded-full border border-mist/40 px-4 py-3 text-sm text-glass transition hover:border-glass/50"
          >
            Unlock
          </button>
        </form>
        <p id="blog-gate-error" class="mt-3 text-xs text-amber-400"></p>
      </div>
    </div>
    <svg
      aria-hidden="true"
      focusable="false"
      width="0"
      height="0"
      style="position:absolute; width:0; height:0; overflow:hidden;"
    >
      <filter
        id="liquid-hero-filter"
        x="-40%"
        y="-40%"
        width="180%"
        height="180%"
        color-interpolation-filters="sRGB"
      >
        <feTurbulence
          type="fractalNoise"
          baseFrequency="0.008 0.02"
          numOctaves="2"
          seed="8"
          result="noise"></feTurbulence>
        <feDisplacementMap
          id="liquid-hero-displacement"
          in="SourceGraphic"
          in2="noise"
          scale="0"
          xChannelSelector="R"
          yChannelSelector="G"></feDisplacementMap>
      </filter>
    </svg>
    <div class="film-overlay" aria-hidden="true">
      <div class="film-grain"></div>
      <div class="film-vignette"></div>
    </div>
  </body>
</html>

<style>
  :global(.blog-locked body > :not(#blog-gate)) {
    display: none !important;
  }
  :global(.blog-gate) {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: #000;
    z-index: 9999;
  }
  :global(.blog-gate.is-visible) {
    display: flex;
  }
  :global(.blog-gate-card) {
    width: min(90vw, 420px);
  }
</style>
